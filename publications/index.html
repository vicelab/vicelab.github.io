<!DOCTYPE HTML>
<html>

<head>
	<title>
		Publications ~ VICE Lab
	</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<link rel="stylesheet" href="../assets/css/main.css" />
</head>

<body class="is-preload">

	<div id="wrapper">

		<header id="header">
			<h1>
				<a href="../#">VICE Lab</a>
			</h1>
			<nav class="links">
				<ul id="navigation_top">
				</ul>
			</nav>
			<nav class="main">
				<ul>
					<li class="menu">
						<a class="fa-bars" href="#menu">Menu</a>
					</li>
				</ul>
			</nav>
		</header>

		<section id="menu">
			<section>
				<ul class="links" id="navigation_side">
				</ul>
			</section>
		</section>

		<div id="main">

			<article class="post">
				<header style="border-bottom:0px; margin: -3em 0 0 0">
					<div class="title">
						<h2>
							<a href="#">Publications</a>
						</h2>
						<p>See the papers that VICE Lab has produced!</p>
					</div>
				</header>

			</article>

			<article id="publications"></article>
		</div>

		<section id="sidebar">
			<section id="intro">
				<h2>Tags</h2>
			</section>

			<section class="blurb" id="tags">
			</section>

			<section id="intro">
				<h2>Locations</h2>
			</section>

			<section class="blurb" id="locations">
			</section>

			<section id="footer">
			</section>
		</section>
	</div>

	<script src="/assets/js/jquery.min.js"></script>
	<script src="/assets/js/jquery.csv.min.js"></script>
	<script src="/assets/js/browser.min.js"></script>
	<script src="/assets/js/breakpoints.min.js"></script>
	<script src="/assets/js/util.js"></script>
	<script src="/assets/js/main.js"></script>
	<script>
	function escapeHTML(text) {
		return text.replace(/&/g, "&amp;")
				   .replace(/</g, "&lt;")
				   .replace(/>/g, "&gt;")
				   .replace(/"/g, "&quot;")
				   .replace(/'/g, "&#039;");
	}

	$(function () {
	  $.get("../snippets/navigation.html")
		.then(function (text) {
		  $("#navigation_top").append($.parseHTML(text));
		  $("#navigation_side").append($.parseHTML(text));
		})
		.fail(function () {
		  console.error("Failed to load navigation.");
		});

	  $("#footer").load("../snippets/footer.html", function (response, status, xhr) {
		if (status === "error") {
		  console.error("Failed to load footer.", xhr.status, xhr.statusText);
		}
	  });

	  $.get("/publications.csv")
		.then(function (text) {
		  var data = $.csv.toObjects(text);
				var visited_tags = [];
				var visited_locations = [];

				data.forEach((item) => {
					// Ensure required fields exist
					if (!item.ID || !item.NAME || !item.ABSTRACT) return;

					// --- AUTHORS: use slug for URL, formatted name for display ---
					let authors_html = (item.AUTHOR || "").split(";").map(author => {
						author = author.trim();
						if (!author) return '';
						let displayName = author
							.split('-')
							.map(word => word.charAt(0).toUpperCase() + word.slice(1))
							.join(' ');
						return `
							<a href="/people/#${author}" class="author">
								<span class="name">${escapeHTML(displayName)}</span>
							</a>`;
					}).join("");

					// --- TAGS: sidebar buttons + inline buttons + filter classes ---
					let tags_classes = '';
					let tags_buttons_html = '';
					(item.TAGS || "").split(";").forEach(tag => {
						tag = tag.trim();
  						if (!tag) return;
						tags_classes += `${tag} `;
						if (!visited_tags.includes(tag)) {
							visited_tags.push(tag);
							$("#tags").append(
								`<a href="#" class="button" onclick="filterSelection('${tag}')">${escapeHTML(tag)}</a>`
							);
						}
						tags_buttons_html += `<a href="#" class="button tag-inline" onclick="filterSelection('${tag}')">${escapeHTML(tag)}</a>`;
					});

					// --- LOCATIONS: sidebar buttons + filter classes ---
					let location_classes = '';
					(item.LOCATION || "").split(";").forEach(location => {
						location = location.trim();
						if (!location) return;
						location_classes += `${location} `;
						if (!visited_locations.includes(location)) {
							visited_locations.push(location);
							$("#locations").append(
								`<a href="#" class="button" onclick="filterSelection('${location}')">${escapeHTML(location)}</a>`
							);
						}
						// Add locations into the main class list so they filter too
						tags_classes += `${location} `;
					});

					// --- ABSTRACT: short/long split with "Show More" ---
					let articleArr = (item.ABSTRACT || "").split(" ");
					let firstSection = articleArr.slice(0, 50).join(" ");
					let secondSection = articleArr.slice(50).join(" ");
					let showMoreBTN = secondSection
						? `<button onclick="showMoreText('${item.ID}')" class="button small">Show More</button>`
						: '';

					// --- CITATION: APA-style line under title ---
					let citation_html = "";
					if (item.CITATION) {
						// Extract URL at end of citation
						let citationText = item.CITATION.trim();
						let urlMatch = citationText.match(/https?:\/\/\S+/);

						if (urlMatch) {
							let url = urlMatch[0];
							let citationWithoutURL = citationText.replace(url, "").trim();

							citation_html =
								`<p class="citation" style="margin:.5em 0 1em 0; font-style: italic;">` +
									`${escapeHTML(citationWithoutURL)} ` +
									`<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>` +
								`</p>`;
						} else {
							citation_html =
								`<p class="citation" style="margin:.5em 0 1em 0; font-style: italic;">` +
									`${escapeHTML(citationText)}` +
								`</p>`;
						}
}
					$("#publications").append(`
						<div style="margin: 0 0 2em 0;" class="post ${tags_classes.trim()} filterDiv">
							<header style="margin:-3em 0 -1.1em 0">
								<div class="title">
									<h3 id="${item.ID}">
										<a href="${item.LINK}">${escapeHTML(item.NAME)}</a>
									</h3>
									<div class="tags-meta" style="margin-top:.5em;">${tags_buttons_html}</div>
								</div>
								<div class="meta">
									<time class="published">${item.DATE}</time>
									${authors_html}
								</div>
							</header>
							${citation_html}
							<p style="margin:0;display:block">
								<span>${escapeHTML(firstSection)}</span>
								<span class="show" id="${item.ID}Dots">${secondSection ? '...' : ''}</span>
								<span class="hide" style="margin:0;" id="${item.ID}ShowText">${escapeHTML(secondSection)}</span>
								${showMoreBTN}
							</p>
						</div>
					`);
				});

				// Initialize filtering
				filterSelection("all");
			})
        .fail(function (xhr, status, error) {
            console.error("Error loading publications:", status, error);
            $("#publications").append("<p>Error loading publications. Please try again later.</p>");
        });
	});

	function filterSelection(c) {
		const posts = document.getElementsByClassName("post");
		Array.from(posts).forEach(post => {
			post.style.display = "none";
			if (c === "all" || post.className.includes(c)) {
				post.style.display = "block";
			}
		});
	}

	function showMoreText(elementID) {
		const text = document.getElementById(`${elementID}ShowText`);
		const dots = document.getElementById(`${elementID}Dots`);
		if (text) text.style.display = "inline";
		if (dots) dots.style.display = "none";

		// Hide the "Show More" button after clicking
		const button = document.querySelector(`#publications [onclick="showMoreText('${elementID}')"]`);
		if (button) button.style.display = "none";
	}

	</script>
</body>

</html>
